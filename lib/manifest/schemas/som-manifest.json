{
  "$id": "https://schemas.site-o-matic.com/manifest.json",
  "type": "object",
  "description": "A site-o-matic manifest",
  "properties": {
    "rootDomainName": {
      "description": "The root domain name for this site",
      "type": "string",
      "minLength": 4
    },
    "title": {
      "description": "Human readable title for the site",
      "type": "string"
    },
    "dns": {
      "description": "DNS specification",
      "$ref": "#/definitions/dnsClause"
    },
    "webmasterEmail": {
      "description": "Email address for the site webmaster",
      "type": "string",
      "pattern": "^.+@.+\\..+$"
    },
    "protected": {
      "description": "Whether to preserve resources even if the Cloudformation stack is deleted",
      "type": "boolean"
    },
    "webHosting": {
      "description": "Web hosting specification",
      "$ref": "#/definitions/webHostingClause"
    },
    "certificate": {
      "description": "SSL certificate specification",
      "$ref": "#/definitions/certificateClause"
    },
    "registrar": {
      "description": "ID of the registrar that the domain has been registered with",
      "type": "string",
      "minLength": 1
    },
    "pipeline": {
      "description": "Pipeline specification",
      "$ref": "#/definitions/pipelineClause"
    },
    "crossAccountAccess": {
      "description": "Cross account permissions specification",
      "type": "array",
      "items": {
        "$ref": "#/definitions/crossAccountAccessSpec"
      }
    }
  },
  "required": ["rootDomainName"],
  "additionalProperties": false,
  "definitions": {
    "mxDnsRecordSpec": {
      "type": "object",
      "properties": {
        "type": {
          "const": "MX"
        },
        "hostName": {
          "type": "string",
          "minLength": 1
        },
        "priority": {
          "type": "number",
          "minimum": 10,
          "multipleOf": 10
        }
      }
    },
    "cnameDnsRecordSpec": {
      "type": "object",
      "properties": {
        "type": {
          "const": "CNAME"
        },
        "recordName": {
          "type": "string",
          "minLength": 1
        },
        "domainName": {
          "type": "string"
        }
      }
    },
    "txtDnsRecordSpec": {
      "type": "object",
      "properties": {
        "type": {
          "const": "TXT"
        },
        "recordName": {
          "type": "string"
        },
        "values": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "dnsRecordSpec": {
      "oneOf": [
        { "$ref": "#/definitions/mxDnsRecordSpec" },
        { "$ref": "#/definitions/cnameDnsRecordSpec" },
        { "$ref": "#/definitions/txtDnsRecordSpec" }
      ]
    },
    "subdomainsClause": {
      "type": "object",
      "properties": {
        "domainName": {
          "type": "string",
          "minLength": 4
        },
        "extraDnsConfig": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/dnsRecordSpec"
          }
        }
      },
      "required": ["domainName"],
      "additionalProperties": false
    },
    "dnsClause": {
      "type": "object",
      "properties": {
        "domainName": {
          "type": "string",
          "minLength": 4
        },
        "extraDnsConfig": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/dnsRecordSpec"
          }
        },
        "subdomains": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/subdomainsClause"
          }
        }
      },
      "required": ["domainName"],
      "additionalProperties": false
    },
    "certificateCloneSpec": {
      "type": "object",
      "properties": {
        "name": {
          "description": "Name of the account to clone into",
          "type": "string",
          "minLength": 1,
          "examples": ["mws-development"]
        },
        "account": {
          "description": "AWS account ID",
          "type": "string",
          "minLength": 12,
          "examples": ["111111111111"]
        },
        "region": {
          "description": "AWS region",
          "type": "string",
          "minLength": 1,
          "examples": ["eu-north-1"]
        }
      },
      "required": ["name", "account", "region"],
      "additionalProperties": false
    },
    "certificateClause": {
      "type": "object",
      "properties": {
        "clones": {
          "description": "Accounts to clone the certificate into",
          "type": "array",
          "items": {
            "$ref": "#/definitions/certificateCloneSpec"
          }
        }
      },
      "additionalProperties": false
    },
    "wafAWSManagedRule": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "priority": {
          "type": "number",
          "minimum": 1
        }
      },
      "required": ["name", "priority"]
    },
    "webHostingErrorResponse": {
      "type": "object",
      "properties": {
        "ttl": {
          "type": "number",
          "minimum": 1,
          "description": "The minimum amount of time, in seconds, that you want CloudFront to cache the HTTP status code specified in ErrorCode."
        },
        "httpStatus": {
          "type": "number",
          "minimum": 100,
          "maximum": 599
        },
        "responseHttpStatus": {
          "type": "number",
          "minimum": 100,
          "maximum": 599
        },
        "responsePagePath": {
          "type": "string",
          "minLength": 1
        }
      },
      "required": ["httpStatus", "responsePagePath"],
      "additionalProperties": false
    },
    "webHostingClauseCloudfrontS3": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "cloudfront-s3"
        },
        "originPath": {
          "type": "string",
          "minLength": 1,
          "default": "/www"
        },
        "defaultRootObject": {
          "type": "string",
          "minLength": 1,
          "default": "index.html"
        },
        "errorResponses": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/webHostingErrorResponse"
          }
        },
        "waf": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "AWSManagedRules": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/wafAWSManagedRule"
              }
            }
          },
          "required": ["enabled"]
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "webHostingClause": {
      "oneOf": [{ "$ref": "#/definitions/webHostingClauseCloudfrontS3" }]
    },
    "codestarConnectionArn": {
      "type": "string",
      "pattern": "^arn:aws:codestar-connections:.*"
    },
    "pipelineBuildPhases": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "commands": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "minItems": 1
          }
        }
      }
    },
    "pipelineClauseCodeCommitS3": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "codecommit-s3"
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "pipelineClauseCodeCommitCustom": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "codecommit-custom"
        },
        "buildPhases": {
          "$ref": "#/definitions/pipelineBuildPhases"
        }
      },
      "required": ["type", "buildPhases"],
      "additionalProperties": false
    },
    "pipelineClauseCodeStarS3": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "codestar-s3"
        },
        "codestarConnectionArn": {
          "$ref": "#/definitions/codestarConnectionArn"
        },
        "owner": {
          "type": "string",
          "minLength": 1
        },
        "repo": {
          "type": "string",
          "minLength": 1
        }
      },
      "required": ["type", "codestarConnectionArn", "owner", "repo"],
      "additionalProperties": false
    },
    "pipelineClauseCodeStarCustom": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "codestar-custom"
        },
        "codestarConnectionArn": {
          "$ref": "#/definitions/codestarConnectionArn"
        },
        "owner": {
          "type": "string",
          "minLength": 1
        },
        "repo": {
          "type": "string",
          "minLength": 1
        },
        "buildPhases": {
          "$ref": "#/definitions/pipelineBuildPhases"
        }
      },
      "required": ["type", "codestarConnectionArn", "owner", "repo", "buildPhases"],
      "additionalProperties": false
    },
    "pipelineClause": {
      "oneOf": [
        { "$ref": "#/definitions/pipelineClauseCodeCommitS3" },
        { "$ref": "#/definitions/pipelineClauseCodeCommitCustom" },
        { "$ref": "#/definitions/pipelineClauseCodeStarS3" },
        { "$ref": "#/definitions/pipelineClauseCodeStarCustom" }
      ]
    },
    "crossAccountAccessSpec": {
      "type": "object",
      "properties": {
        "name": {
          "description": "Name of the account to clone into",
          "type": "string",
          "minLength": 1,
          "examples": ["mws-development"]
        },
        "arn": {
          "description": "AWS account ARN",
          "type": "string",
          "pattern": "arn.+"
        }
      },
      "required": ["name", "arn"],
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "rootDomainName": "example.org"
    },
    {
      "rootDomainName": "example.com",
      "title": "example.com",
      "webmasterEmail": "webmaster@example.com",
      "registrar": "dynadot",
      "protected": true,
      "dns": {
        "domainName": "example.com",
        "extraDnsConfig": [
          {
            "type": "MX",
            "hostName": "in1-smtp.example.com",
            "priority": 10
          },
          {
            "type": "CNAME",
            "recordName": "fm1._domainkey.example.com",
            "domainName": "fm1.example.com.dkim.example.com"
          },
          {
            "type": "TXT",
            "recordName": "",
            "values": ["v=spf1 include:spf.example.com ?all"]
          }
        ],
        "subdomains": [{ "domainName": "dev.example.com" }]
      },
      "webHosting": {
        "type": "cloudfront-s3",
        "originPath": "/www",
        "defaultRootObject": "index.html",
        "errorResponses": [
          { "httpStatus": 403, "responsePagePath": "/403.html" },
          { "httpStatus": 404, "responsePagePath": "/404.html" }
        ],
        "waf": {
          "enabled": true,
          "AWSManagedRules": [
            { "name": "AWSManagedRulesCommonRuleSet", "priority": 10 },
            { "name": "AWSManagedRulesBotControlRuleSet", "priority": 20 }
          ]
        }
      },
      "pipeline": {
        "type": "codestar-custom",
        "codestarConnectionArn": "arn:aws:codestar-connections:us-east-1:111111111111:connection/12345678-cafe-cafe-cafe-123456789012",
        "owner": "example",
        "repo": "example.com",
        "buildPhases": {
          "install": {
            "commands": ["npm install"]
          },
          "build": {
            "commands": ["npm run build"]
          }
        }
      },
      "certificate": {
        "clones": [
          {
            "name": "eg-development",
            "account": "111111111111",
            "region": "eu-north-1"
          },
          {
            "name": "eg-production",
            "account": "222222222222",
            "region": "eu-north-1"
          }
        ]
      },
      "crossAccountAccess": [
        {
          "name": "eg-development",
          "arn": "arn:aws:sts::111111111111:role/OrganizationAccountAccessRole"
        },
        {
          "name": "eg-production",
          "arn": "arn:aws:iam::222222222222:role/OrganizationAccountAccessRole"
        }
      ]
    }
  ]
}
